

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>dill._dill &mdash; pycalphad 0.8+2.gf784c38 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> pycalphad
          

          
            
            <img src="../../_static/pycalphad-logo-withtext.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.8+2.gf784c38
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../INSTALLING.html">Installation Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/modules.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CHANGES.html">Whatâ€™s New</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pycalphad</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>dill._dill</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for dill._dill</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">#</span>
<span class="c1"># Author: Mike McKerns (mmckerns @caltech and @uqfoundation)</span>
<span class="c1"># Copyright (c) 2008-2015 California Institute of Technology.</span>
<span class="c1"># Copyright (c) 2016-2019 The Uncertainty Quantification Foundation.</span>
<span class="c1"># License: 3-clause BSD.  The full license text is available at:</span>
<span class="c1">#  - https://github.com/uqfoundation/dill/blob/master/LICENSE</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">dill: a utility for serialization of python objects</span>

<span class="sd">Based on code written by Oren Tirosh and Armin Ronacher.</span>
<span class="sd">Extended to a (near) full set of the builtin types (in types module),</span>
<span class="sd">and coded to the pickle interface, by &lt;mmckerns@caltech.edu&gt;.</span>
<span class="sd">Initial port to python3 by Jonathan Dobson, continued by mmckerns.</span>
<span class="sd">Test against &quot;all&quot; python types (Std. Lib. CH 1-15 @ 2.7) by mmckerns.</span>
<span class="sd">Test against CH16+ Std. Lib. ... TBD.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dump&#39;</span><span class="p">,</span><span class="s1">&#39;dumps&#39;</span><span class="p">,</span><span class="s1">&#39;load&#39;</span><span class="p">,</span><span class="s1">&#39;loads&#39;</span><span class="p">,</span><span class="s1">&#39;dump_session&#39;</span><span class="p">,</span><span class="s1">&#39;load_session&#39;</span><span class="p">,</span>
           <span class="s1">&#39;Pickler&#39;</span><span class="p">,</span><span class="s1">&#39;Unpickler&#39;</span><span class="p">,</span><span class="s1">&#39;register&#39;</span><span class="p">,</span><span class="s1">&#39;copy&#39;</span><span class="p">,</span><span class="s1">&#39;pickle&#39;</span><span class="p">,</span><span class="s1">&#39;pickles&#39;</span><span class="p">,</span>
           <span class="s1">&#39;check&#39;</span><span class="p">,</span><span class="s1">&#39;HIGHEST_PROTOCOL&#39;</span><span class="p">,</span><span class="s1">&#39;DEFAULT_PROTOCOL&#39;</span><span class="p">,</span><span class="s1">&#39;PicklingError&#39;</span><span class="p">,</span>
           <span class="s1">&#39;UnpicklingError&#39;</span><span class="p">,</span><span class="s1">&#39;HANDLE_FMODE&#39;</span><span class="p">,</span><span class="s1">&#39;CONTENTS_FMODE&#39;</span><span class="p">,</span><span class="s1">&#39;FILE_FMODE&#39;</span><span class="p">]</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;dill&quot;</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">_trace</span><span class="p">(</span><span class="n">boolean</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;print a trace through the stack when pickling; useful for debugging&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">boolean</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARN</span><span class="p">)</span>
    <span class="k">return</span>

<span class="n">stack</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># record of &#39;recursion-sensitive&#39; pickled objects</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">diff</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_use_diff</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">PY3</span> <span class="o">=</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">hexversion</span> <span class="o">&gt;=</span> <span class="mh">0x30000f0</span><span class="p">)</span>
<span class="c1"># OLDER: 3.0 &lt;= x &lt; 3.4 *OR* x &lt; 2.7.10  #NOTE: guessing relevant versions</span>
<span class="n">OLDER</span> <span class="o">=</span> <span class="p">(</span><span class="n">PY3</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">hexversion</span> <span class="o">&lt;</span> <span class="mh">0x30400f0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">hexversion</span> <span class="o">&lt;</span> <span class="mh">0x2070af0</span><span class="p">)</span>
<span class="n">PY34</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x30400f0</span> <span class="o">&lt;=</span> <span class="n">sys</span><span class="o">.</span><span class="n">hexversion</span> <span class="o">&lt;</span> <span class="mh">0x30500f0</span><span class="p">)</span>
<span class="k">if</span> <span class="n">PY3</span><span class="p">:</span> <span class="c1">#XXX: get types from .objtypes ?</span>
    <span class="kn">import</span> <span class="nn">builtins</span> <span class="k">as</span> <span class="nn">__builtin__</span>
    <span class="kn">from</span> <span class="nn">pickle</span> <span class="k">import</span> <span class="n">_Pickler</span> <span class="k">as</span> <span class="n">StockPickler</span><span class="p">,</span> <span class="n">Unpickler</span> <span class="k">as</span> <span class="n">StockUnpickler</span>
    <span class="kn">from</span> <span class="nn">_thread</span> <span class="k">import</span> <span class="n">LockType</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">hexversion</span> <span class="o">&gt;=</span> <span class="mh">0x30200f0</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">_thread</span> <span class="k">import</span> <span class="n">RLock</span> <span class="k">as</span> <span class="n">RLockType</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">threading</span> <span class="k">import</span> <span class="n">_RLock</span> <span class="k">as</span> <span class="n">RLockType</span>
   <span class="c1">#from io import IOBase</span>
    <span class="kn">from</span> <span class="nn">types</span> <span class="k">import</span> <span class="n">CodeType</span><span class="p">,</span> <span class="n">FunctionType</span><span class="p">,</span> <span class="n">MethodType</span><span class="p">,</span> <span class="n">GeneratorType</span><span class="p">,</span> \
        <span class="n">TracebackType</span><span class="p">,</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">ModuleType</span><span class="p">,</span> <span class="n">BuiltinMethodType</span>
    <span class="n">BufferType</span> <span class="o">=</span> <span class="nb">memoryview</span> <span class="c1">#XXX: unregistered</span>
    <span class="n">ClassType</span> <span class="o">=</span> <span class="nb">type</span> <span class="c1"># no &#39;old-style&#39; classes</span>
    <span class="n">EllipsisType</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">Ellipsis</span><span class="p">)</span>
   <span class="c1">#FileType = IOBase</span>
    <span class="n">NotImplementedType</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">NotImplemented</span><span class="p">)</span>
    <span class="n">SliceType</span> <span class="o">=</span> <span class="nb">slice</span>
    <span class="n">TypeType</span> <span class="o">=</span> <span class="nb">type</span> <span class="c1"># &#39;new-style&#39; classes #XXX: unregistered</span>
    <span class="n">XRangeType</span> <span class="o">=</span> <span class="nb">range</span>
    <span class="n">DictProxyType</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="nb">object</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">__builtin__</span>
    <span class="kn">from</span> <span class="nn">pickle</span> <span class="k">import</span> <span class="n">Pickler</span> <span class="k">as</span> <span class="n">StockPickler</span><span class="p">,</span> <span class="n">Unpickler</span> <span class="k">as</span> <span class="n">StockUnpickler</span>
    <span class="kn">from</span> <span class="nn">thread</span> <span class="k">import</span> <span class="n">LockType</span>
    <span class="kn">from</span> <span class="nn">threading</span> <span class="k">import</span> <span class="n">_RLock</span> <span class="k">as</span> <span class="n">RLockType</span>
    <span class="kn">from</span> <span class="nn">types</span> <span class="k">import</span> <span class="n">CodeType</span><span class="p">,</span> <span class="n">FunctionType</span><span class="p">,</span> <span class="n">ClassType</span><span class="p">,</span> <span class="n">MethodType</span><span class="p">,</span> \
         <span class="n">GeneratorType</span><span class="p">,</span> <span class="n">DictProxyType</span><span class="p">,</span> <span class="n">XRangeType</span><span class="p">,</span> <span class="n">SliceType</span><span class="p">,</span> <span class="n">TracebackType</span><span class="p">,</span> \
         <span class="n">NotImplementedType</span><span class="p">,</span> <span class="n">EllipsisType</span><span class="p">,</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">ModuleType</span><span class="p">,</span> \
         <span class="n">BufferType</span><span class="p">,</span> <span class="n">BuiltinMethodType</span><span class="p">,</span> <span class="n">TypeType</span>
<span class="kn">from</span> <span class="nn">pickle</span> <span class="k">import</span> <span class="n">HIGHEST_PROTOCOL</span><span class="p">,</span> <span class="n">PicklingError</span><span class="p">,</span> <span class="n">UnpicklingError</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pickle</span> <span class="k">import</span> <span class="n">DEFAULT_PROTOCOL</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">DEFAULT_PROTOCOL</span> <span class="o">=</span> <span class="n">HIGHEST_PROTOCOL</span>
<span class="kn">import</span> <span class="nn">__main__</span> <span class="k">as</span> <span class="nn">_main_module</span>
<span class="kn">import</span> <span class="nn">marshal</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="c1"># import zlib</span>
<span class="kn">from</span> <span class="nn">weakref</span> <span class="k">import</span> <span class="n">ReferenceType</span><span class="p">,</span> <span class="n">ProxyType</span><span class="p">,</span> <span class="n">CallableProxyType</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="k">import</span> <span class="n">itemgetter</span><span class="p">,</span> <span class="n">attrgetter</span>
<span class="c1"># new in python3.3</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">hexversion</span> <span class="o">&lt;</span> <span class="mh">0x03030000</span><span class="p">:</span>
    <span class="ne">FileNotFoundError</span> <span class="o">=</span> <span class="ne">IOError</span>
<span class="k">if</span> <span class="n">PY3</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">hexversion</span> <span class="o">&lt;</span> <span class="mh">0x03040000</span><span class="p">:</span>
    <span class="n">GENERATOR_FAIL</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">else</span><span class="p">:</span> <span class="n">GENERATOR_FAIL</span> <span class="o">=</span> <span class="kc">False</span>    
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">ctypes</span>
    <span class="n">HAS_CTYPES</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># if using `pypy`, pythonapi is not found</span>
    <span class="n">IS_PYPY</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ctypes</span><span class="p">,</span> <span class="s1">&#39;pythonapi&#39;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">HAS_CTYPES</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">IS_PYPY</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">NumpyUfuncType</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">NumpyArrayType</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">OLDER</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;find_spec not found&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">importlib</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">importlib</span><span class="o">.</span><span class="n">machinery</span><span class="o">.</span><span class="n">PathFinder</span><span class="p">()</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s1">&#39;numpy&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;No module named &#39;numpy&#39;&quot;</span><span class="p">)</span>
    <span class="n">NumpyUfuncType</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">NumpyArrayType</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">imp</span>
        <span class="n">imp</span><span class="o">.</span><span class="n">find_module</span><span class="p">(</span><span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
        <span class="n">NumpyUfuncType</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">NumpyArrayType</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">pass</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="k">def</span> <span class="nf">__hook__</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">NumpyArrayType</span><span class="p">,</span> <span class="n">NumpyUfuncType</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">ufunc</span> <span class="k">as</span> <span class="n">NumpyUfuncType</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">ndarray</span> <span class="k">as</span> <span class="n">NumpyArrayType</span>
    <span class="k">return</span> <span class="kc">True</span>
<span class="k">if</span> <span class="n">NumpyArrayType</span><span class="p">:</span> <span class="c1"># then has numpy</span>
    <span class="k">def</span> <span class="nf">ndarraysubclassinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="n">TypeType</span><span class="p">,</span> <span class="n">ClassType</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span> <span class="c1"># all classes return False</span>
        <span class="k">try</span><span class="p">:</span> <span class="c1"># check if is ndarray, and elif is subclass of ndarray</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;__class__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">TypeType</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="s1">&#39;numpy.ndarray&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;mro&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="o">.</span><span class="n">mro</span><span class="p">)()):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">ReferenceError</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span> <span class="c1"># handle &#39;R3&#39; weakref in 3.x</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># anything below here is a numpy array (or subclass) instance</span>
        <span class="n">__hook__</span><span class="p">()</span> <span class="c1"># import numpy (so the following works!!!)</span>
        <span class="c1"># verify that __reduce__ has not been overridden</span>
        <span class="n">NumpyInstance</span> <span class="o">=</span> <span class="n">NumpyArrayType</span><span class="p">((</span><span class="mi">0</span><span class="p">,),</span><span class="s1">&#39;int8&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__reduce_ex__</span><span class="p">)</span> <span class="o">==</span> <span class="nb">id</span><span class="p">(</span><span class="n">NumpyInstance</span><span class="o">.</span><span class="n">__reduce_ex__</span><span class="p">)</span> <span class="ow">and</span> \
           <span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__reduce__</span><span class="p">)</span> <span class="o">==</span> <span class="nb">id</span><span class="p">(</span><span class="n">NumpyInstance</span><span class="o">.</span><span class="n">__reduce__</span><span class="p">):</span> <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">def</span> <span class="nf">numpyufunc</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="n">TypeType</span><span class="p">,</span> <span class="n">ClassType</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span> <span class="c1"># all classes return False</span>
        <span class="k">try</span><span class="p">:</span> <span class="c1"># check if is ufunc</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;__class__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">TypeType</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="s1">&#39;numpy.ufunc&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;mro&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="o">.</span><span class="n">mro</span><span class="p">)()):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">ReferenceError</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span> <span class="c1"># handle &#39;R3&#39; weakref in 3.x</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># anything below here is a numpy ufunc</span>
        <span class="k">return</span> <span class="kc">True</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">ndarraysubclassinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span> <span class="k">return</span> <span class="kc">False</span>
    <span class="k">def</span> <span class="nf">numpyufunc</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span> <span class="k">return</span> <span class="kc">False</span>

<span class="c1"># make sure to add these &#39;hand-built&#39; types to _typemap</span>
<span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
    <span class="n">CellType</span> <span class="o">=</span> <span class="nb">type</span><span class="p">((</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="p">)(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="vm">__closure__</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">CellType</span> <span class="o">=</span> <span class="nb">type</span><span class="p">((</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="p">)(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">func_closure</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="c1"># new in python2.5</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">hexversion</span> <span class="o">&gt;=</span> <span class="mh">0x20500f0</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">types</span> <span class="k">import</span> <span class="n">GetSetDescriptorType</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">IS_PYPY</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">types</span> <span class="k">import</span> <span class="n">MemberDescriptorType</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># oddly, MemberDescriptorType is GetSetDescriptorType</span>
        <span class="c1"># while, member_descriptor does exist otherwise... is this a pypy bug?</span>
        <span class="k">class</span> <span class="nc">_member</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;descriptor&#39;</span><span class="p">]</span>
        <span class="n">MemberDescriptorType</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">_member</span><span class="o">.</span><span class="n">descriptor</span><span class="p">)</span>
<span class="k">if</span> <span class="n">IS_PYPY</span><span class="p">:</span>
    <span class="n">WrapperDescriptorType</span> <span class="o">=</span> <span class="n">MethodType</span>
    <span class="n">MethodDescriptorType</span> <span class="o">=</span> <span class="n">FunctionType</span>
    <span class="n">ClassMethodDescriptorType</span> <span class="o">=</span> <span class="n">FunctionType</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">WrapperDescriptorType</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="nb">type</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">)</span>
    <span class="n">MethodDescriptorType</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="nb">type</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;mro&#39;</span><span class="p">])</span>
    <span class="n">ClassMethodDescriptorType</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="nb">type</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;__prepare__&#39;</span> <span class="k">if</span> <span class="n">PY3</span> <span class="k">else</span> <span class="s1">&#39;mro&#39;</span><span class="p">])</span>

<span class="n">MethodWrapperType</span> <span class="o">=</span> <span class="nb">type</span><span class="p">([]</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">)</span>
<span class="n">PartialType</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="n">base</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
<span class="n">SuperType</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">()))</span>
<span class="n">ItemGetterType</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<span class="n">AttrGetterType</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;__repr__&#39;</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">get_file_type</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="nb">open</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;open&quot;</span><span class="p">,</span> <span class="n">__builtin__</span><span class="o">.</span><span class="n">open</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">t</span>

<span class="n">FileType</span> <span class="o">=</span> <span class="n">get_file_type</span><span class="p">(</span><span class="s1">&#39;rb&#39;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">TextWrapperType</span> <span class="o">=</span> <span class="n">get_file_type</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">BufferedRandomType</span> <span class="o">=</span> <span class="n">get_file_type</span><span class="p">(</span><span class="s1">&#39;r+b&#39;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">BufferedReaderType</span> <span class="o">=</span> <span class="n">get_file_type</span><span class="p">(</span><span class="s1">&#39;rb&#39;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">BufferedWriterType</span> <span class="o">=</span> <span class="n">get_file_type</span><span class="p">(</span><span class="s1">&#39;wb&#39;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">_pyio</span> <span class="k">import</span> <span class="nb">open</span> <span class="k">as</span> <span class="n">_open</span>
    <span class="n">PyTextWrapperType</span> <span class="o">=</span> <span class="n">get_file_type</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">open</span><span class="o">=</span><span class="n">_open</span><span class="p">)</span>
    <span class="n">PyBufferedRandomType</span> <span class="o">=</span> <span class="n">get_file_type</span><span class="p">(</span><span class="s1">&#39;r+b&#39;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">open</span><span class="o">=</span><span class="n">_open</span><span class="p">)</span>
    <span class="n">PyBufferedReaderType</span> <span class="o">=</span> <span class="n">get_file_type</span><span class="p">(</span><span class="s1">&#39;rb&#39;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">open</span><span class="o">=</span><span class="n">_open</span><span class="p">)</span>
    <span class="n">PyBufferedWriterType</span> <span class="o">=</span> <span class="n">get_file_type</span><span class="p">(</span><span class="s1">&#39;wb&#39;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">open</span><span class="o">=</span><span class="n">_open</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">PyTextWrapperType</span> <span class="o">=</span> <span class="n">PyBufferedRandomType</span> <span class="o">=</span> <span class="n">PyBufferedReaderType</span> <span class="o">=</span> <span class="n">PyBufferedWriterType</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">cStringIO</span> <span class="k">import</span> <span class="n">StringIO</span><span class="p">,</span> <span class="n">InputType</span><span class="p">,</span> <span class="n">OutputType</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">io</span> <span class="k">import</span> <span class="n">BytesIO</span> <span class="k">as</span> <span class="n">StringIO</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">StringIO</span> <span class="k">import</span> <span class="n">StringIO</span>
    <span class="n">InputType</span> <span class="o">=</span> <span class="n">OutputType</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">__IPYTHON__</span> <span class="ow">is</span> <span class="kc">True</span> <span class="c1"># is ipython</span>
    <span class="n">ExitType</span> <span class="o">=</span> <span class="kc">None</span>     <span class="c1"># IPython.core.autocall.ExitAutocall</span>
    <span class="n">singletontypes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="s1">&#39;quit&#39;</span><span class="p">,</span> <span class="s1">&#39;get_ipython&#39;</span><span class="p">]</span>
<span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span> <span class="n">ExitType</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">exit</span><span class="p">)</span> <span class="c1"># apparently &#39;exit&#39; can be removed</span>
    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span> <span class="n">ExitType</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">singletontypes</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1">### File modes</span>
<span class="c1"># Pickles the file handle, preserving mode. The position of the unpickled</span>
<span class="c1"># object is as for a new file handle.</span>
<span class="n">HANDLE_FMODE</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1"># Pickles the file contents, creating a new file if on load the file does</span>
<span class="c1"># not exist. The position = min(pickled position, EOF) and mode is chosen</span>
<span class="c1"># as such that &quot;best&quot; preserves behavior of the original file.</span>
<span class="n">CONTENTS_FMODE</span> <span class="o">=</span> <span class="mi">1</span>
<span class="c1"># Pickles the entire file (handle and contents), preserving mode and position.</span>
<span class="n">FILE_FMODE</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1">### Shorthands (modified from python2.5/lib/pickle.py)</span>
<span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;use pickling to &#39;copy&#39; an object&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">loads</span><span class="p">(</span><span class="n">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">byref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span><span class="c1">#, strictio=None):</span>
    <span class="sd">&quot;&quot;&quot;pickle an object to a file&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.settings</span> <span class="k">import</span> <span class="n">settings</span>
    <span class="n">strictio</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1">#FIXME: strict=True needs cleanup</span>
    <span class="k">if</span> <span class="n">protocol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">protocol</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;protocol&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">byref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">byref</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;byref&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">fmode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">fmode</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;fmode&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">recurse</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">recurse</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;recurse&#39;</span><span class="p">]</span>
    <span class="n">stack</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>  <span class="c1"># clear record of &#39;recursion-sensitive&#39; pickled objects</span>
    <span class="n">pik</span> <span class="o">=</span> <span class="n">Pickler</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">protocol</span><span class="p">)</span>
    <span class="n">pik</span><span class="o">.</span><span class="n">_main</span> <span class="o">=</span> <span class="n">_main_module</span>
    <span class="c1"># apply kwd settings</span>
    <span class="n">pik</span><span class="o">.</span><span class="n">_byref</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">byref</span><span class="p">)</span>
    <span class="n">pik</span><span class="o">.</span><span class="n">_strictio</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">strictio</span><span class="p">)</span>
    <span class="n">pik</span><span class="o">.</span><span class="n">_fmode</span> <span class="o">=</span> <span class="n">fmode</span>
    <span class="n">pik</span><span class="o">.</span><span class="n">_recurse</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">recurse</span><span class="p">)</span>
    <span class="c1"># register if the object is a numpy ufunc</span>
    <span class="c1"># thanks to Paul Kienzle for pointing out ufuncs didn&#39;t pickle</span>
    <span class="k">if</span> <span class="n">NumpyUfuncType</span> <span class="ow">and</span> <span class="n">numpyufunc</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="nd">@register</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
        <span class="k">def</span> <span class="nf">save_numpy_ufunc</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Nu: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
            <span class="n">StockPickler</span><span class="o">.</span><span class="n">save_global</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# Nu&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># NOTE: the above &#39;save&#39; performs like:</span>
        <span class="c1">#   import copy_reg</span>
        <span class="c1">#   def udump(f): return f.__name__</span>
        <span class="c1">#   def uload(name): return getattr(numpy, name)</span>
        <span class="c1">#   copy_reg.pickle(NumpyUfuncType, udump, uload)</span>
    <span class="c1"># register if the object is a subclassed numpy array instance</span>
    <span class="k">if</span> <span class="n">NumpyArrayType</span> <span class="ow">and</span> <span class="n">ndarraysubclassinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="nd">@register</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
        <span class="k">def</span> <span class="nf">save_numpy_array</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Nu: (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">obj</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
            <span class="n">npdict</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;__dict__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__reduce__</span><span class="p">()</span>
            <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_create_array</span><span class="p">,</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">args</span><span class="p">,</span><span class="n">state</span><span class="p">,</span><span class="n">npdict</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# Nu&quot;</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="c1"># end hack</span>
    <span class="k">if</span> <span class="n">GENERATOR_FAIL</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">==</span> <span class="n">GeneratorType</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Can&#39;t pickle </span><span class="si">%s</span><span class="s2">: attribute lookup builtins.generator failed&quot;</span> <span class="o">%</span> <span class="n">GeneratorType</span>
        <span class="k">raise</span> <span class="n">PicklingError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pik</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">stack</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>  <span class="c1"># clear record of &#39;recursion-sensitive&#39; pickled objects</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">byref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span><span class="c1">#, strictio=None):</span>
    <span class="sd">&quot;&quot;&quot;pickle an object to a string&quot;&quot;&quot;</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
    <span class="n">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">byref</span><span class="p">,</span> <span class="n">fmode</span><span class="p">,</span> <span class="n">recurse</span><span class="p">)</span><span class="c1">#, strictio)</span>
    <span class="k">return</span> <span class="n">file</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;unpickle an object from a file&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.settings</span> <span class="k">import</span> <span class="n">settings</span>
    <span class="k">if</span> <span class="n">ignore</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;ignore&#39;</span><span class="p">]</span>
    <span class="n">pik</span> <span class="o">=</span> <span class="n">Unpickler</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="n">pik</span><span class="o">.</span><span class="n">_main</span> <span class="o">=</span> <span class="n">_main_module</span>
    <span class="c1"># apply kwd settings</span>
    <span class="n">pik</span><span class="o">.</span><span class="n">_ignore</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">ignore</span><span class="p">)</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">pik</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_main_module</span><span class="p">,</span> <span class="s1">&#39;__name__&#39;</span><span class="p">,</span> <span class="s1">&#39;__main__&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore</span><span class="p">:</span>
            <span class="c1"># point obj class to main</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pik</span><span class="o">.</span><span class="n">_main</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span><span class="ne">TypeError</span><span class="p">):</span> <span class="k">pass</span> <span class="c1"># defined in a file</span>
   <span class="c1">#_main_module.__dict__.update(obj.__dict__) #XXX: should update globals ?</span>
    <span class="k">return</span> <span class="n">obj</span>

<span class="k">def</span> <span class="nf">loads</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;unpickle an object from a string&quot;&quot;&quot;</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">ignore</span><span class="p">)</span>

<span class="c1"># def dumpzs(obj, protocol=None):</span>
<span class="c1">#     &quot;&quot;&quot;pickle an object to a compressed string&quot;&quot;&quot;</span>
<span class="c1">#     return zlib.compress(dumps(obj, protocol))</span>

<span class="c1"># def loadzs(str):</span>
<span class="c1">#     &quot;&quot;&quot;unpickle an object from a compressed string&quot;&quot;&quot;</span>
<span class="c1">#     return loads(zlib.decompress(str))</span>

<span class="c1">### End: Shorthands ###</span>

<span class="c1">### Pickle the Interpreter Session</span>
<span class="k">def</span> <span class="nf">_module_map</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;get map of imported modules&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>
    <span class="n">modmap</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">items</span> <span class="o">=</span> <span class="s1">&#39;items&#39;</span> <span class="k">if</span> <span class="n">PY3</span> <span class="k">else</span> <span class="s1">&#39;iteritems&#39;</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">module</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">,</span> <span class="n">items</span><span class="p">)():</span>
        <span class="k">if</span> <span class="n">module</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">objname</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">module</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">modmap</span><span class="p">[</span><span class="n">objname</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">modmap</span>

<span class="k">def</span> <span class="nf">_lookup_module</span><span class="p">(</span><span class="n">modmap</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">main_module</span><span class="p">):</span> <span class="c1">#FIXME: needs work</span>
    <span class="sd">&quot;&quot;&quot;lookup name if module is imported&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">modobj</span><span class="p">,</span> <span class="n">modname</span> <span class="ow">in</span> <span class="n">modmap</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">modobj</span> <span class="ow">is</span> <span class="n">obj</span> <span class="ow">and</span> <span class="n">modname</span> <span class="o">!=</span> <span class="n">main_module</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">modname</span>

<span class="k">def</span> <span class="nf">_stash_modules</span><span class="p">(</span><span class="n">main_module</span><span class="p">):</span>
    <span class="n">modmap</span> <span class="o">=</span> <span class="n">_module_map</span><span class="p">()</span>
    <span class="n">imported</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">original</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">items</span> <span class="o">=</span> <span class="s1">&#39;items&#39;</span> <span class="k">if</span> <span class="n">PY3</span> <span class="k">else</span> <span class="s1">&#39;iteritems&#39;</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">main_module</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span> <span class="n">items</span><span class="p">)():</span>
        <span class="n">source_module</span> <span class="o">=</span> <span class="n">_lookup_module</span><span class="p">(</span><span class="n">modmap</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">main_module</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">source_module</span><span class="p">:</span>
            <span class="n">imported</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">source_module</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">original</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">imported</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">types</span>
        <span class="n">newmod</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">(</span><span class="n">main_module</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">newmod</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>
        <span class="n">newmod</span><span class="o">.</span><span class="n">__dill_imported</span> <span class="o">=</span> <span class="n">imported</span>
        <span class="k">return</span> <span class="n">newmod</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">original</span>

<span class="k">def</span> <span class="nf">_restore_modules</span><span class="p">(</span><span class="n">main_module</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;__dill_imported&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">main_module</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">imports</span> <span class="o">=</span> <span class="n">main_module</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;__dill_imported&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">module</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">imports</span><span class="p">:</span>
        <span class="n">exec</span><span class="p">(</span><span class="s2">&quot;from </span><span class="si">%s</span><span class="s2"> import </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="n">main_module</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

<span class="c1">#NOTE: 06/03/15 renamed main_module to main</span>
<span class="k">def</span> <span class="nf">dump_session</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;/tmp/session.pkl&#39;</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">byref</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;pickle the current state of __main__ to a file&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.settings</span> <span class="k">import</span> <span class="n">settings</span>
    <span class="n">protocol</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;protocol&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">main</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">main</span> <span class="o">=</span> <span class="n">_main_module</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">filename</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">byref</span><span class="p">:</span>
            <span class="n">main</span> <span class="o">=</span> <span class="n">_stash_modules</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
        <span class="n">pickler</span> <span class="o">=</span> <span class="n">Pickler</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">protocol</span><span class="p">)</span>
        <span class="n">pickler</span><span class="o">.</span><span class="n">_main</span> <span class="o">=</span> <span class="n">main</span>
        <span class="n">pickler</span><span class="o">.</span><span class="n">_byref</span> <span class="o">=</span> <span class="kc">False</span>   <span class="c1"># disable pickling by name reference</span>
        <span class="n">pickler</span><span class="o">.</span><span class="n">_recurse</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># disable pickling recursion for globals</span>
        <span class="n">pickler</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># is best indicator of when pickling a session</span>
        <span class="n">pickler</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>  <span class="c1"># If newly opened file</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">load_session</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;/tmp/session.pkl&#39;</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;update the __main__ module with the state from the session file&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">main</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">main</span> <span class="o">=</span> <span class="n">_main_module</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">filename</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">unpickler</span> <span class="o">=</span> <span class="n">Unpickler</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">unpickler</span><span class="o">.</span><span class="n">_main</span> <span class="o">=</span> <span class="n">main</span>
        <span class="n">unpickler</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">unpickler</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="n">unpickler</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">main</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="n">_restore_modules</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>  <span class="c1"># If newly opened file</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span>

<span class="c1">### End: Pickle the Interpreter</span>

<span class="k">class</span> <span class="nc">MetaCatchingDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>

    <span class="k">def</span> <span class="nf">__missing__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">save_type</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">()</span>


<span class="c1">### Extend the Picklers</span>
<span class="k">class</span> <span class="nc">Pickler</span><span class="p">(</span><span class="n">StockPickler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;python&#39;s Pickler extended to interpreter sessions&quot;&quot;&quot;</span>
    <span class="n">dispatch</span> <span class="o">=</span> <span class="n">MetaCatchingDict</span><span class="p">(</span><span class="n">StockPickler</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="n">_main</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_session</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="kn">from</span> <span class="nn">.settings</span> <span class="k">import</span> <span class="n">settings</span>
    <span class="n">_byref</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;byref&#39;</span><span class="p">]</span>
    <span class="n">_strictio</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_fmode</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;fmode&#39;</span><span class="p">]</span>
    <span class="n">_recurse</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;recurse&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="n">_byref</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;byref&#39;</span><span class="p">,</span> <span class="n">Pickler</span><span class="o">.</span><span class="n">_byref</span><span class="p">)</span>
       <span class="c1">#_strictio = kwds.pop(&#39;strictio&#39;, Pickler._strictio)</span>
        <span class="n">_fmode</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;fmode&#39;</span><span class="p">,</span> <span class="n">Pickler</span><span class="o">.</span><span class="n">_fmode</span><span class="p">)</span>
        <span class="n">_recurse</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;recurse&#39;</span><span class="p">,</span> <span class="n">Pickler</span><span class="o">.</span><span class="n">_recurse</span><span class="p">)</span>
        <span class="n">StockPickler</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_main</span> <span class="o">=</span> <span class="n">_main_module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_diff_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_byref</span> <span class="o">=</span> <span class="n">_byref</span>
       <span class="c1">#self._strictio = _strictio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fmode</span> <span class="o">=</span> <span class="n">_fmode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_recurse</span> <span class="o">=</span> <span class="n">_recurse</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">Unpickler</span><span class="p">(</span><span class="n">StockUnpickler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;python&#39;s Unpickler extended to interpreter sessions and more types&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.settings</span> <span class="k">import</span> <span class="n">settings</span>
    <span class="n">_ignore</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;ignore&#39;</span><span class="p">]</span>
    <span class="n">_main</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_session</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">find_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="s1">&#39;__builtin__&#39;</span><span class="p">,</span> <span class="s1">&#39;__main__&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_main</span><span class="o">.</span><span class="vm">__dict__</span> <span class="c1">#XXX: above set w/save_module_dict</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="s1">&#39;__builtin__&#39;</span><span class="p">,</span> <span class="s1">&#39;NoneType&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="c1">#XXX: special case: NoneType missing</span>
        <span class="k">if</span> <span class="n">module</span> <span class="o">==</span> <span class="s1">&#39;dill.dill&#39;</span><span class="p">:</span> <span class="n">module</span> <span class="o">=</span> <span class="s1">&#39;dill._dill&#39;</span>
        <span class="k">return</span> <span class="n">StockUnpickler</span><span class="o">.</span><span class="n">find_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="n">_ignore</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">Unpickler</span><span class="o">.</span><span class="n">_ignore</span><span class="p">)</span>
        <span class="n">StockUnpickler</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_main</span> <span class="o">=</span> <span class="n">_main_module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ignore</span> <span class="o">=</span> <span class="n">_ignore</span>
    <span class="k">pass</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">def dispatch_table():</span>
<span class="sd">    &quot;&quot;&quot;get the dispatch table of registered types&quot;&quot;&quot;</span>
<span class="sd">    return Pickler.dispatch</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="n">pickle_dispatch_copy</span> <span class="o">=</span> <span class="n">StockPickler</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">pickle</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;expose dispatch table for user-created extensions&quot;&quot;&quot;</span>
    <span class="n">Pickler</span><span class="o">.</span><span class="n">dispatch</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">proxy</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="n">Pickler</span><span class="o">.</span><span class="n">dispatch</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">return</span> <span class="n">func</span>
    <span class="k">return</span> <span class="n">proxy</span>

<span class="k">def</span> <span class="nf">_revert_extension</span><span class="p">():</span>
    <span class="k">for</span> <span class="nb">type</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">StockPickler</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="vm">__name__</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">StockPickler</span><span class="o">.</span><span class="n">dispatch</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">type</span> <span class="ow">in</span> <span class="n">pickle_dispatch_copy</span><span class="p">:</span>
                <span class="n">StockPickler</span><span class="o">.</span><span class="n">dispatch</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="n">pickle_dispatch_copy</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">use_diff</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    reduces size of pickles by only including object which have changed.</span>
<span class="sd">    Decreases pickle size but increases CPU time needed.</span>
<span class="sd">    Also helps avoid some unpicklable objects.</span>
<span class="sd">    MUST be called at start of script, otherwise changes will not be recorded.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_use_diff</span><span class="p">,</span> <span class="n">diff</span>
    <span class="n">_use_diff</span> <span class="o">=</span> <span class="n">on</span>
    <span class="k">if</span> <span class="n">_use_diff</span> <span class="ow">and</span> <span class="n">diff</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">diff</span> <span class="k">as</span> <span class="n">d</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">diff</span> <span class="k">as</span> <span class="nn">d</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">d</span>

<span class="k">def</span> <span class="nf">_create_typemap</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">types</span>
    <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">__builtin__</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="o">+</span> \
                 <span class="nb">list</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="n">builtin</span> <span class="o">=</span> <span class="s1">&#39;builtins&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span>
        <span class="n">builtin</span> <span class="o">=</span> <span class="s1">&#39;__builtin__&#39;</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;__module__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">builtin</span> \
        <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span>
    <span class="k">return</span>
<span class="n">_reverse_typemap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">_create_typemap</span><span class="p">())</span>
<span class="n">_reverse_typemap</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
    <span class="s1">&#39;CellType&#39;</span><span class="p">:</span> <span class="n">CellType</span><span class="p">,</span>
    <span class="s1">&#39;MethodWrapperType&#39;</span><span class="p">:</span> <span class="n">MethodWrapperType</span><span class="p">,</span>
    <span class="s1">&#39;PartialType&#39;</span><span class="p">:</span> <span class="n">PartialType</span><span class="p">,</span>
    <span class="s1">&#39;SuperType&#39;</span><span class="p">:</span> <span class="n">SuperType</span><span class="p">,</span>
    <span class="s1">&#39;ItemGetterType&#39;</span><span class="p">:</span> <span class="n">ItemGetterType</span><span class="p">,</span>
    <span class="s1">&#39;AttrGetterType&#39;</span><span class="p">:</span> <span class="n">AttrGetterType</span><span class="p">,</span>
    <span class="s1">&#39;FileType&#39;</span><span class="p">:</span> <span class="n">FileType</span><span class="p">,</span>
    <span class="s1">&#39;BufferedRandomType&#39;</span><span class="p">:</span> <span class="n">BufferedRandomType</span><span class="p">,</span>
    <span class="s1">&#39;BufferedReaderType&#39;</span><span class="p">:</span> <span class="n">BufferedReaderType</span><span class="p">,</span>
    <span class="s1">&#39;BufferedWriterType&#39;</span><span class="p">:</span> <span class="n">BufferedWriterType</span><span class="p">,</span>
    <span class="s1">&#39;TextWrapperType&#39;</span><span class="p">:</span> <span class="n">TextWrapperType</span><span class="p">,</span>
    <span class="s1">&#39;PyBufferedRandomType&#39;</span><span class="p">:</span> <span class="n">PyBufferedRandomType</span><span class="p">,</span>
    <span class="s1">&#39;PyBufferedReaderType&#39;</span><span class="p">:</span> <span class="n">PyBufferedReaderType</span><span class="p">,</span>
    <span class="s1">&#39;PyBufferedWriterType&#39;</span><span class="p">:</span> <span class="n">PyBufferedWriterType</span><span class="p">,</span>
    <span class="s1">&#39;PyTextWrapperType&#39;</span><span class="p">:</span> <span class="n">PyTextWrapperType</span><span class="p">,</span>
<span class="p">})</span>
<span class="k">if</span> <span class="n">ExitType</span><span class="p">:</span>
    <span class="n">_reverse_typemap</span><span class="p">[</span><span class="s1">&#39;ExitType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExitType</span>
<span class="k">if</span> <span class="n">InputType</span><span class="p">:</span>
    <span class="n">_reverse_typemap</span><span class="p">[</span><span class="s1">&#39;InputType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">InputType</span>
    <span class="n">_reverse_typemap</span><span class="p">[</span><span class="s1">&#39;OutputType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OutputType</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">IS_PYPY</span><span class="p">:</span>
    <span class="n">_reverse_typemap</span><span class="p">[</span><span class="s1">&#39;WrapperDescriptorType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">WrapperDescriptorType</span>
    <span class="n">_reverse_typemap</span><span class="p">[</span><span class="s1">&#39;MethodDescriptorType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MethodDescriptorType</span>
    <span class="n">_reverse_typemap</span><span class="p">[</span><span class="s1">&#39;ClassMethodDescriptorType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ClassMethodDescriptorType</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">_reverse_typemap</span><span class="p">[</span><span class="s1">&#39;MemberDescriptorType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MemberDescriptorType</span>
<span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
    <span class="n">_typemap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_reverse_typemap</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">_typemap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_reverse_typemap</span><span class="o">.</span><span class="n">iteritems</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">_unmarshal</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">marshal</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_load_type</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_reverse_typemap</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">_create_type</span><span class="p">(</span><span class="n">typeobj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">typeobj</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_create_function</span><span class="p">(</span><span class="n">fcode</span><span class="p">,</span> <span class="n">fglobals</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fdefaults</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> \
                                      <span class="n">fclosure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fdict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># same as FunctionType, but enable passing __dict__ to new function,</span>
    <span class="c1"># __dict__ is the storehouse for attributes added after function creation</span>
    <span class="k">if</span> <span class="n">fdict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">fdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">FunctionType</span><span class="p">(</span><span class="n">fcode</span><span class="p">,</span> <span class="n">fglobals</span> <span class="ow">or</span> <span class="nb">dict</span><span class="p">(),</span> <span class="n">fname</span><span class="p">,</span> <span class="n">fdefaults</span><span class="p">,</span> <span class="n">fclosure</span><span class="p">)</span>
    <span class="n">func</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fdict</span><span class="p">)</span> <span class="c1">#XXX: better copy? option to copy?</span>
    <span class="k">return</span> <span class="n">func</span>

<span class="k">def</span> <span class="nf">_create_ftype</span><span class="p">(</span><span class="n">ftypeobj</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwds</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">kwds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kwds</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">()</span>
    <span class="k">return</span> <span class="n">ftypeobj</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_create_lock</span><span class="p">(</span><span class="n">locked</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span> <span class="c1">#XXX: ignores &#39;blocking&#39;</span>
    <span class="kn">from</span> <span class="nn">threading</span> <span class="k">import</span> <span class="n">Lock</span>
    <span class="n">lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">locked</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="kc">False</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">UnpicklingError</span><span class="p">(</span><span class="s2">&quot;Cannot acquire lock&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lock</span>

<span class="k">def</span> <span class="nf">_create_rlock</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span> <span class="c1">#XXX: ignores &#39;blocking&#39;</span>
    <span class="n">lock</span> <span class="o">=</span> <span class="n">RLockType</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">owner</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">_acquire_restore</span><span class="p">((</span><span class="n">count</span><span class="p">,</span> <span class="n">owner</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">owner</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">lock</span><span class="o">.</span><span class="n">_is_owned</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">UnpicklingError</span><span class="p">(</span><span class="s2">&quot;Cannot acquire lock&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lock</span>

<span class="c1"># thanks to matsjoyce for adding all the different file modes</span>
<span class="k">def</span> <span class="nf">_create_filehandle</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">closed</span><span class="p">,</span> <span class="nb">open</span><span class="p">,</span> <span class="n">strictio</span><span class="p">,</span> <span class="n">fmode</span><span class="p">,</span> <span class="n">fdata</span><span class="p">):</span> <span class="c1"># buffering=0</span>
    <span class="c1"># only pickles the handle, not the file contents... good? or StringIO(data)?</span>
    <span class="c1"># (for file contents see: http://effbot.org/librarybook/copy-reg.htm)</span>
    <span class="c1"># NOTE: handle special cases first (are there more special cases?)</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;&lt;stdin&gt;&#39;</span><span class="p">:</span><span class="n">sys</span><span class="o">.</span><span class="n">__stdin__</span><span class="p">,</span> <span class="s1">&#39;&lt;stdout&gt;&#39;</span><span class="p">:</span><span class="n">sys</span><span class="o">.</span><span class="n">__stdout__</span><span class="p">,</span>
             <span class="s1">&#39;&lt;stderr&gt;&#39;</span><span class="p">:</span><span class="n">sys</span><span class="o">.</span><span class="n">__stderr__</span><span class="p">}</span> <span class="c1">#XXX: better fileno=(0,1,2) ?</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">names</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="c1">#XXX: safer &quot;f=sys.stdin&quot;</span>
    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&lt;tmpfile&gt;&#39;</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">tmpfile</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&lt;fdopen&gt;&#39;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">tempfile</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># treat x mode as w mode</span>
        <span class="k">if</span> <span class="s2">&quot;x&quot;</span> <span class="ow">in</span> <span class="n">mode</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">hexversion</span> <span class="o">&lt;</span> <span class="mh">0x03030000</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid mode: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">exists</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">strictio</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;[Errno 2] No such file or directory: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;r&quot;</span> <span class="ow">in</span> <span class="n">mode</span> <span class="ow">and</span> <span class="n">fmode</span> <span class="o">!=</span> <span class="n">FILE_FMODE</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;&lt;fdopen&gt;&#39;</span> <span class="c1"># or os.devnull?</span>
            <span class="n">current_size</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># or maintain position?</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">position</span> <span class="o">&gt;</span> <span class="n">current_size</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">strictio</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid buffer size&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">fmode</span> <span class="o">==</span> <span class="n">CONTENTS_FMODE</span><span class="p">:</span>
                <span class="n">position</span> <span class="o">=</span> <span class="n">current_size</span>
        <span class="c1"># try to open the file by name</span>
        <span class="c1"># NOTE: has different fileno</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1">#FIXME: missing: *buffering*, encoding, softspace</span>
            <span class="k">if</span> <span class="n">fmode</span> <span class="o">==</span> <span class="n">FILE_FMODE</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span> <span class="k">if</span> <span class="s2">&quot;w&quot;</span> <span class="ow">in</span> <span class="n">mode</span> <span class="k">else</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fdata</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;w&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&lt;fdopen&gt;&#39;</span><span class="p">:</span> <span class="c1"># file did not exist</span>
                <span class="kn">import</span> <span class="nn">tempfile</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">fmode</span> <span class="o">==</span> <span class="n">CONTENTS_FMODE</span> \
               <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;w&quot;</span> <span class="ow">in</span> <span class="n">mode</span> <span class="ow">or</span> <span class="s2">&quot;x&quot;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">):</span>
                <span class="c1"># stop truncation when opening</span>
                <span class="n">flags</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">O_CREAT</span>
                <span class="k">if</span> <span class="s2">&quot;+&quot;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
                    <span class="n">flags</span> <span class="o">|=</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDWR</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">flags</span> <span class="o">|=</span> <span class="n">os</span><span class="o">.</span><span class="n">O_WRONLY</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">flags</span><span class="p">),</span> <span class="n">mode</span><span class="p">)</span>
                <span class="c1"># set name to the correct value</span>
                <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;buffer&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;raw&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">HAS_CTYPES</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;No module named &#39;ctypes&#39;&quot;</span><span class="p">)</span>
                    <span class="k">class</span> <span class="nc">FILE</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
                        <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;refcount&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_long</span><span class="p">),</span>
                                    <span class="p">(</span><span class="s2">&quot;type_obj&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">py_object</span><span class="p">),</span>
                                    <span class="p">(</span><span class="s2">&quot;file_pointer&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_voidp</span><span class="p">),</span>
                                    <span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">py_object</span><span class="p">)]</span>

                    <span class="k">class</span> <span class="nc">PyObject</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
                        <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="p">(</span><span class="s2">&quot;ob_refcnt&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">),</span>
                            <span class="p">(</span><span class="s2">&quot;ob_type&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">py_object</span><span class="p">)</span>
                            <span class="p">]</span>
                    <span class="c1">#FIXME: CONTENTS_FMODE fails for pypy due to issue #1233</span>
                    <span class="c1">#       https://bitbucket.org/pypy/pypy/issues/1233</span>
                    <span class="n">ctypes</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">FILE</span><span class="p">))</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
                    <span class="n">ctypes</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">PyObject</span><span class="p">))</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">ob_refcnt</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">assert</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">):</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">raise</span> <span class="n">UnpicklingError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">closed</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">position</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">fmode</span> <span class="o">!=</span> <span class="n">HANDLE_FMODE</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span>

<span class="k">def</span> <span class="nf">_create_stringi</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">closed</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">closed</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span>

<span class="k">def</span> <span class="nf">_create_stringo</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">closed</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">closed</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
       <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
       <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span>

<span class="k">class</span> <span class="nc">_itemgetter_helper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span>

<span class="k">class</span> <span class="nc">_attrgetter_helper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">attrs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
    <span class="k">def</span> <span class="nf">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;attrs&quot;</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
            <span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">attrs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">attrs</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">attr</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>

<span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">_create_cell</span><span class="p">(</span><span class="n">contents</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="n">contents</span><span class="p">)</span><span class="o">.</span><span class="vm">__closure__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">_create_cell</span><span class="p">(</span><span class="n">contents</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="n">contents</span><span class="p">)</span><span class="o">.</span><span class="n">func_closure</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">_create_weakref</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">weakref</span> <span class="k">import</span> <span class="n">ref</span>
    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># it&#39;s dead</span>
        <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">UserDict</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">UserDict</span> <span class="k">import</span> <span class="n">UserDict</span>
        <span class="k">return</span> <span class="n">ref</span><span class="p">(</span><span class="n">UserDict</span><span class="p">(),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ref</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_create_weakproxy</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">callable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">weakref</span> <span class="k">import</span> <span class="n">proxy</span>
    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># it&#39;s dead</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">:</span> <span class="k">return</span> <span class="n">proxy</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">UserDict</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">UserDict</span> <span class="k">import</span> <span class="n">UserDict</span>
        <span class="k">return</span> <span class="n">proxy</span><span class="p">(</span><span class="n">UserDict</span><span class="p">(),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">proxy</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_eval_repr</span><span class="p">(</span><span class="n">repr_str</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">repr_str</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_create_array</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">npdict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
   <span class="c1">#array = numpy.core.multiarray._reconstruct(*args)</span>
    <span class="n">array</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="n">array</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">npdict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># we also have saved state in __dict__</span>
        <span class="n">array</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">npdict</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">array</span>

<span class="k">def</span> <span class="nf">_create_namedtuple</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fieldnames</span><span class="p">,</span> <span class="n">modulename</span><span class="p">):</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="n">_import_module</span><span class="p">(</span><span class="n">modulename</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="kn">import</span> <span class="nn">collections</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fieldnames</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">=</span> <span class="n">modulename</span>
    <span class="k">return</span> <span class="n">t</span>

<span class="k">def</span> <span class="nf">_getattr</span><span class="p">(</span><span class="n">objclass</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">repr_str</span><span class="p">):</span>
    <span class="c1"># hack to grab the reference directly</span>
    <span class="k">try</span><span class="p">:</span> <span class="c1">#XXX: works only for __builtin__ ?</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">repr_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">attr</span><span class="o">+</span><span class="s1">&#39;.__dict__[&quot;&#39;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;&quot;]&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">objclass</span><span class="o">.</span><span class="vm">__dict__</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="ow">is</span> <span class="n">DictProxyType</span><span class="p">:</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="n">attr</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">objclass</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">objclass</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">attr</span>

<span class="k">def</span> <span class="nf">_get_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="c1"># stop recursive pickling</span>
    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">__builtin__</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_dict_from_dictproxy</span><span class="p">(</span><span class="n">dictproxy</span><span class="p">):</span>
    <span class="n">_dict</span> <span class="o">=</span> <span class="n">dictproxy</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># convert dictproxy to dict</span>
    <span class="n">_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;__dict__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;__weakref__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;__prepare__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_dict</span>

<span class="k">def</span> <span class="nf">_import_module</span><span class="p">(</span><span class="n">import_name</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">import_name</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">import_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">module</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">items</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">import_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">__import__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="n">obj</span><span class="p">]),</span> <span class="n">obj</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">safe</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">raise</span>

<span class="k">def</span> <span class="nf">_locate_function</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__module__</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;__main__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span> <span class="c1"># and session:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">found</span> <span class="o">=</span> <span class="n">_import_module</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">found</span> <span class="ow">is</span> <span class="n">obj</span>

<span class="c1">#@register(CodeType)</span>
<span class="c1">#def save_code(pickler, obj):</span>
<span class="c1">#    log.info(&quot;Co: %s&quot; % obj)</span>
<span class="c1">#    pickler.save_reduce(_unmarshal, (marshal.dumps(obj),), obj=obj)</span>
<span class="c1">#    log.info(&quot;# Co&quot;)</span>
<span class="c1">#    return</span>

<span class="c1"># The following function is based on &#39;save_codeobject&#39; from &#39;cloudpickle&#39;</span>
<span class="c1"># Copyright (c) 2012, Regents of the University of California.</span>
<span class="c1"># Copyright (c) 2009 `PiCloud, Inc. &lt;http://www.picloud.com&gt;`_.</span>
<span class="c1"># License: https://github.com/cloudpipe/cloudpickle/blob/master/LICENSE</span>
<span class="nd">@register</span><span class="p">(</span><span class="n">CodeType</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">save_code</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Co: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">co_argcount</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_kwonlyargcount</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_nlocals</span><span class="p">,</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">co_stacksize</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_flags</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_code</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_consts</span><span class="p">,</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">co_names</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_filename</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">co_firstlineno</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_lnotab</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_freevars</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_cellvars</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">co_argcount</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_nlocals</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_stacksize</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_flags</span><span class="p">,</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">co_code</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_consts</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_names</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">,</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">co_filename</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_firstlineno</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_lnotab</span><span class="p">,</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">co_freevars</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_cellvars</span>
        <span class="p">)</span>
    <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">CodeType</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# Co&quot;</span><span class="p">)</span>
    <span class="k">return</span>

<span class="nd">@register</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">save_module_dict</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">is_dill</span><span class="p">(</span><span class="n">pickler</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj</span> <span class="o">==</span> <span class="n">pickler</span><span class="o">.</span><span class="n">_main</span><span class="o">.</span><span class="vm">__dict__</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pickler</span><span class="o">.</span><span class="n">_session</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;D1: &lt;dict</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;dict&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># obj</span>
        <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
            <span class="n">pickler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="s1">&#39;c__builtin__</span><span class="se">\n</span><span class="s1">__main__</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;UTF-8&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pickler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;c__builtin__</span><span class="se">\n</span><span class="s1">__main__</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# D1&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="n">is_dill</span><span class="p">(</span><span class="n">pickler</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">obj</span> <span class="o">==</span> <span class="n">_main_module</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;D3: &lt;dict</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;dict&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># obj</span>
        <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
            <span class="n">pickler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="s1">&#39;c__main__</span><span class="se">\n</span><span class="s1">__dict__</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;UTF-8&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pickler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;c__main__</span><span class="se">\n</span><span class="s1">__dict__</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>   <span class="c1">#XXX: works in general?</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# D3&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s1">&#39;__name__&#39;</span> <span class="ow">in</span> <span class="n">obj</span> <span class="ow">and</span> <span class="n">obj</span> <span class="o">!=</span> <span class="n">_main_module</span><span class="o">.</span><span class="vm">__dict__</span> \
    <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;__name__&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span> \
    <span class="ow">and</span> <span class="n">obj</span> <span class="ow">is</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_import_module</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;__name__&#39;</span><span class="p">],</span><span class="kc">True</span><span class="p">),</span> <span class="s1">&#39;__dict__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;D4: &lt;dict</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;dict&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># obj</span>
        <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
            <span class="n">pickler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="s1">&#39;c</span><span class="si">%s</span><span class="se">\n</span><span class="s1">__dict__</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;__name__&#39;</span><span class="p">],</span> <span class="s1">&#39;UTF-8&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pickler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;c</span><span class="si">%s</span><span class="se">\n</span><span class="s1">__dict__</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;__name__&#39;</span><span class="p">])</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# D4&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;D2: &lt;dict</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;dict&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># obj</span>
        <span class="k">if</span> <span class="n">is_dill</span><span class="p">(</span><span class="n">pickler</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pickler</span><span class="o">.</span><span class="n">_session</span><span class="p">:</span>
            <span class="c1"># we only care about session the first pass thru</span>
            <span class="n">pickler</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">StockPickler</span><span class="o">.</span><span class="n">save_dict</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# D2&quot;</span><span class="p">)</span>
    <span class="k">return</span>

<span class="nd">@register</span><span class="p">(</span><span class="n">ClassType</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">save_classobj</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span> <span class="c1">#FIXME: enable pickler._byref</span>
   <span class="c1">#stack[id(obj)] = len(stack), obj</span>
    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span> <span class="c1">#XXX: use _main_module.__name__ everywhere?</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;C1: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
        <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">ClassType</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">,</span>
                                        <span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
                                       <span class="c1">#XXX: or obj.__dict__.copy()), obj=obj) ?</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# C1&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;C2: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
        <span class="n">StockPickler</span><span class="o">.</span><span class="n">save_global</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# C2&quot;</span><span class="p">)</span>
    <span class="k">return</span>

<span class="nd">@register</span><span class="p">(</span><span class="n">LockType</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">save_lock</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Lo: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
    <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_create_lock</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">locked</span><span class="p">(),),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# Lo&quot;</span><span class="p">)</span>
    <span class="k">return</span>

<span class="nd">@register</span><span class="p">(</span><span class="n">RLockType</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">save_rlock</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RL: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span> <span class="c1"># don&#39;t use _release_save as it unlocks the lock</span>
    <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;count=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">))</span>
    <span class="n">owner</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;owner=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">PY3</span> <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;_RLock__owner&#39;</span><span class="p">)</span>
    <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_create_rlock</span><span class="p">,</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="n">owner</span><span class="p">,),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# RL&quot;</span><span class="p">)</span>
    <span class="k">return</span>

<span class="nd">@register</span><span class="p">(</span><span class="n">ItemGetterType</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">save_itemgetter</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Ig: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
    <span class="n">helper</span> <span class="o">=</span> <span class="n">_itemgetter_helper</span><span class="p">()</span>
    <span class="n">obj</span><span class="p">(</span><span class="n">helper</span><span class="p">)</span>
    <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">helper</span><span class="o">.</span><span class="n">items</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# Ig&quot;</span><span class="p">)</span>
    <span class="k">return</span>

<span class="nd">@register</span><span class="p">(</span><span class="n">AttrGetterType</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">save_attrgetter</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Ag: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">helper</span> <span class="o">=</span> <span class="n">_attrgetter_helper</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
    <span class="n">obj</span><span class="p">(</span><span class="n">helper</span><span class="p">)</span>
    <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">attrs</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# Ag&quot;</span><span class="p">)</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">_save_file</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">open_</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
        <span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">in</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">__stdout__</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">__stderr__</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">__stdin__</span><span class="p">):</span>
            <span class="n">position</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">position</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">is_dill</span><span class="p">(</span><span class="n">pickler</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pickler</span><span class="o">.</span><span class="n">_fmode</span> <span class="o">==</span> <span class="n">FILE_FMODE</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">open_</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="n">fdata</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fdata</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_dill</span><span class="p">(</span><span class="n">pickler</span><span class="p">):</span>
        <span class="n">strictio</span> <span class="o">=</span> <span class="n">pickler</span><span class="o">.</span><span class="n">_strictio</span>
        <span class="n">fmode</span> <span class="o">=</span> <span class="n">pickler</span><span class="o">.</span><span class="n">_fmode</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">strictio</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">fmode</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># HANDLE_FMODE</span>
    <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_create_filehandle</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span>
                                             <span class="n">obj</span><span class="o">.</span><span class="n">closed</span><span class="p">,</span> <span class="n">open_</span><span class="p">,</span> <span class="n">strictio</span><span class="p">,</span>
                                             <span class="n">fmode</span><span class="p">,</span> <span class="n">fdata</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">return</span>


<span class="nd">@register</span><span class="p">(</span><span class="n">FileType</span><span class="p">)</span> <span class="c1">#XXX: in 3.x has buffer=0, needs different _create?</span>
<span class="nd">@register</span><span class="p">(</span><span class="n">BufferedRandomType</span><span class="p">)</span>
<span class="nd">@register</span><span class="p">(</span><span class="n">BufferedReaderType</span><span class="p">)</span>
<span class="nd">@register</span><span class="p">(</span><span class="n">BufferedWriterType</span><span class="p">)</span>
<span class="nd">@register</span><span class="p">(</span><span class="n">TextWrapperType</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">save_file</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fi: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">_save_file</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="nb">open</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# Fi&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span>

<span class="k">if</span> <span class="n">PyTextWrapperType</span><span class="p">:</span>
    <span class="nd">@register</span><span class="p">(</span><span class="n">PyBufferedRandomType</span><span class="p">)</span>
    <span class="nd">@register</span><span class="p">(</span><span class="n">PyBufferedReaderType</span><span class="p">)</span>
    <span class="nd">@register</span><span class="p">(</span><span class="n">PyBufferedWriterType</span><span class="p">)</span>
    <span class="nd">@register</span><span class="p">(</span><span class="n">PyTextWrapperType</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">save_file</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fi: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">_save_file</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">_open</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# Fi&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span>

<span class="c1"># The following two functions are based on &#39;saveCStringIoInput&#39;</span>
<span class="c1"># and &#39;saveCStringIoOutput&#39; from spickle</span>
<span class="c1"># Copyright (c) 2011 by science+computing ag</span>
<span class="c1"># License: http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="k">if</span> <span class="n">InputType</span><span class="p">:</span>
    <span class="nd">@register</span><span class="p">(</span><span class="n">InputType</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">save_stringi</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Io: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span> <span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">getvalue</span><span class="p">();</span> <span class="n">position</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_create_stringi</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> \
                                              <span class="n">obj</span><span class="o">.</span><span class="n">closed</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# Io&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="nd">@register</span><span class="p">(</span><span class="n">OutputType</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">save_stringo</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Io: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span> <span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">getvalue</span><span class="p">();</span> <span class="n">position</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_create_stringo</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> \
                                              <span class="n">obj</span><span class="o">.</span><span class="n">closed</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# Io&quot;</span><span class="p">)</span>
        <span class="k">return</span>

<span class="nd">@register</span><span class="p">(</span><span class="n">PartialType</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">save_functor</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fu: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
    <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_create_ftype</span><span class="p">,</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="n">obj</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">args</span><span class="p">,</span>
                                        <span class="n">obj</span><span class="o">.</span><span class="n">keywords</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# Fu&quot;</span><span class="p">)</span>
    <span class="k">return</span>

<span class="nd">@register</span><span class="p">(</span><span class="n">SuperType</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">save_super</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Su: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
    <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="nb">super</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__thisclass__</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__self__</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# Su&quot;</span><span class="p">)</span>
    <span class="k">return</span>

<span class="nd">@register</span><span class="p">(</span><span class="n">BuiltinMethodType</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">save_builtin_method</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__self__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__self__</span> <span class="ow">is</span> <span class="n">__builtin__</span><span class="p">:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="s1">&#39;builtins&#39;</span> <span class="k">if</span> <span class="n">PY3</span> <span class="k">else</span> <span class="s1">&#39;__builtin__&#39;</span>
            <span class="n">_t</span> <span class="o">=</span> <span class="s2">&quot;B1&quot;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_t</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__self__</span>
            <span class="n">_t</span> <span class="o">=</span> <span class="s2">&quot;B3&quot;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_t</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">is_dill</span><span class="p">(</span><span class="n">pickler</span><span class="p">):</span>
            <span class="n">_recurse</span> <span class="o">=</span> <span class="n">pickler</span><span class="o">.</span><span class="n">_recurse</span>
            <span class="n">pickler</span><span class="o">.</span><span class="n">_recurse</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_get_attr</span><span class="p">,</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_dill</span><span class="p">(</span><span class="n">pickler</span><span class="p">):</span>
            <span class="n">pickler</span><span class="o">.</span><span class="n">_recurse</span> <span class="o">=</span> <span class="n">_recurse</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">_t</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;B2: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
        <span class="n">StockPickler</span><span class="o">.</span><span class="n">save_global</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# B2&quot;</span><span class="p">)</span>
    <span class="k">return</span>

<span class="nd">@register</span><span class="p">(</span><span class="n">MethodType</span><span class="p">)</span> <span class="c1">#FIXME: fails for &#39;hidden&#39; or &#39;name-mangled&#39; classes</span>
<span class="k">def</span> <span class="nf">save_instancemethod0</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span><span class="c1"># example: cStringIO.StringI</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Me: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span> <span class="c1">#XXX: obj.__dict__ handled elsewhere?</span>
    <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
        <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">MethodType</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__func__</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__self__</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">MethodType</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">im_func</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">im_self</span><span class="p">,</span>
                                         <span class="n">obj</span><span class="o">.</span><span class="n">im_class</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# Me&quot;</span><span class="p">)</span>
    <span class="k">return</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">hexversion</span> <span class="o">&gt;=</span> <span class="mh">0x20500f0</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">IS_PYPY</span><span class="p">:</span>
        <span class="nd">@register</span><span class="p">(</span><span class="n">MemberDescriptorType</span><span class="p">)</span>
        <span class="nd">@register</span><span class="p">(</span><span class="n">GetSetDescriptorType</span><span class="p">)</span>
        <span class="nd">@register</span><span class="p">(</span><span class="n">MethodDescriptorType</span><span class="p">)</span>
        <span class="nd">@register</span><span class="p">(</span><span class="n">WrapperDescriptorType</span><span class="p">)</span>
        <span class="nd">@register</span><span class="p">(</span><span class="n">ClassMethodDescriptorType</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">save_wrapper_descriptor</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Wr: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
            <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_getattr</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__objclass__</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                           <span class="n">obj</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# Wr&quot;</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nd">@register</span><span class="p">(</span><span class="n">MemberDescriptorType</span><span class="p">)</span>
        <span class="nd">@register</span><span class="p">(</span><span class="n">GetSetDescriptorType</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">save_wrapper_descriptor</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Wr: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
            <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_getattr</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__objclass__</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                           <span class="n">obj</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# Wr&quot;</span><span class="p">)</span>
            <span class="k">return</span>

    <span class="nd">@register</span><span class="p">(</span><span class="n">MethodWrapperType</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">save_instancemethod</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Mw: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
        <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="nb">getattr</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__self__</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# Mw&quot;</span><span class="p">)</span>
        <span class="k">return</span>

<span class="k">elif</span> <span class="ow">not</span> <span class="n">IS_PYPY</span><span class="p">:</span>
    <span class="nd">@register</span><span class="p">(</span><span class="n">MethodDescriptorType</span><span class="p">)</span>
    <span class="nd">@register</span><span class="p">(</span><span class="n">WrapperDescriptorType</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">save_wrapper_descriptor</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Wr: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
        <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_getattr</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__objclass__</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                       <span class="n">obj</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# Wr&quot;</span><span class="p">)</span>
        <span class="k">return</span>

<span class="nd">@register</span><span class="p">(</span><span class="n">CellType</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">save_cell</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Ce: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">cell_contents</span>
    <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_create_cell</span><span class="p">,</span> <span class="p">(</span><span class="n">f</span><span class="p">,),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# Ce&quot;</span><span class="p">)</span>
    <span class="k">return</span>

<span class="c1"># The following function is based on &#39;saveDictProxy&#39; from spickle</span>
<span class="c1"># Copyright (c) 2011 by science+computing ag</span>
<span class="c1"># License: http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">IS_PYPY</span><span class="p">:</span>
    <span class="nd">@register</span><span class="p">(</span><span class="n">DictProxyType</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">save_dictproxy</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dp: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;__dict__&#39;</span><span class="p">)</span>
       <span class="c1">#pickler.save_reduce(_create_dictproxy, (attr,&#39;nested&#39;), obj=obj)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="o">==</span> <span class="n">GetSetDescriptorType</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__dict__&quot;</span> \
        <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="vm">__objclass__</span><span class="p">,</span> <span class="s2">&quot;__dict__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">obj</span><span class="p">:</span>
            <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="nb">getattr</span><span class="p">,</span> <span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="vm">__objclass__</span><span class="p">,</span><span class="s2">&quot;__dict__&quot;</span><span class="p">),</span><span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# Dp&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># all bad below... so throw ReferenceError or TypeError</span>
        <span class="k">raise</span> <span class="ne">ReferenceError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> does not reference a class __dict__&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>

<span class="nd">@register</span><span class="p">(</span><span class="n">SliceType</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">save_slice</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sl: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
    <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="nb">slice</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">step</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# Sl&quot;</span><span class="p">)</span>
    <span class="k">return</span>

<span class="nd">@register</span><span class="p">(</span><span class="n">XRangeType</span><span class="p">)</span>
<span class="nd">@register</span><span class="p">(</span><span class="n">EllipsisType</span><span class="p">)</span>
<span class="nd">@register</span><span class="p">(</span><span class="n">NotImplementedType</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">save_singleton</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Si: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
    <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_eval_repr</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(),),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# Si&quot;</span><span class="p">)</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">_proxy_helper</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span> <span class="c1"># a dead proxy returns a reference to None</span>
    <span class="sd">&quot;&quot;&quot;get memory address of proxy&#39;s reference object&quot;&quot;&quot;</span>
    <span class="n">_repr</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span> <span class="n">_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ReferenceError</span><span class="p">:</span> <span class="c1"># it&#39;s a dead proxy</span>
        <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_str</span> <span class="o">==</span> <span class="n">_repr</span><span class="p">:</span> <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="c1"># it&#39;s a repr</span>
    <span class="k">try</span><span class="p">:</span> <span class="c1"># either way, it&#39;s a proxy from here</span>
        <span class="n">address</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_str</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; at &#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="c1"># special case: proxy of a &#39;type&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">IS_PYPY</span><span class="p">:</span>
            <span class="n">address</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_repr</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; at &#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">objects</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">get_objects</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">_obj</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">repr</span><span class="p">(</span><span class="n">_obj</span><span class="p">)</span> <span class="o">==</span> <span class="n">_str</span><span class="p">:</span> <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="n">_obj</span><span class="p">)</span>
            <span class="c1"># all bad below... nothing found so throw ReferenceError</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Cannot reference object for proxy at &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ReferenceError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">address</span>

<span class="k">def</span> <span class="nf">_locate_object</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;get object located at the given memory address (inverse of id(obj))&quot;&quot;&quot;</span>
    <span class="n">special</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span> <span class="c1">#XXX: more...?</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">special</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">address</span> <span class="o">==</span> <span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span> <span class="k">return</span> <span class="n">obj</span>
    <span class="k">if</span> <span class="n">module</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
            <span class="n">objects</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">objects</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">itervalues</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">objects</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">get_objects</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">address</span> <span class="o">==</span> <span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span> <span class="k">return</span> <span class="n">obj</span>
    <span class="c1"># all bad below... nothing found so throw ReferenceError or TypeError</span>
    <span class="k">try</span><span class="p">:</span> <span class="n">address</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; is not a valid memory address&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">address</span><span class="p">))</span>
    <span class="k">raise</span> <span class="ne">ReferenceError</span><span class="p">(</span><span class="s2">&quot;Cannot reference object at &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">address</span><span class="p">)</span>

<span class="nd">@register</span><span class="p">(</span><span class="n">ReferenceType</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">save_weakref</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="n">refobj</span> <span class="o">=</span> <span class="n">obj</span><span class="p">()</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;R1: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
   <span class="c1">#refobj = ctypes.pythonapi.PyWeakref_GetObject(obj) # dead returns &quot;None&quot;</span>
    <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_create_weakref</span><span class="p">,</span> <span class="p">(</span><span class="n">refobj</span><span class="p">,),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# R1&quot;</span><span class="p">)</span>
    <span class="k">return</span>

<span class="nd">@register</span><span class="p">(</span><span class="n">ProxyType</span><span class="p">)</span>
<span class="nd">@register</span><span class="p">(</span><span class="n">CallableProxyType</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">save_weakproxy</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="n">refobj</span> <span class="o">=</span> <span class="n">_locate_object</span><span class="p">(</span><span class="n">_proxy_helper</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_t</span> <span class="o">=</span> <span class="s2">&quot;R2&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_t</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">ReferenceError</span><span class="p">:</span>
        <span class="n">_t</span> <span class="o">=</span> <span class="s2">&quot;R3&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_t</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>
   <span class="c1">#callable = bool(getattr(refobj, &#39;__call__&#39;, None))</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">is</span> <span class="n">CallableProxyType</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_create_weakproxy</span><span class="p">,</span> <span class="p">(</span><span class="n">refobj</span><span class="p">,</span> <span class="n">callable</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">_t</span><span class="p">)</span>
    <span class="k">return</span>

<span class="nd">@register</span><span class="p">(</span><span class="n">ModuleType</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">save_module</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span> <span class="c1">#_use_diff:</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="s2">&quot;dill&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">changed</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">whats_changed</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">seen</span><span class="o">=</span><span class="n">pickler</span><span class="o">.</span><span class="n">_diff_cache</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>  <span class="c1"># not memorised module, probably part of dill</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;M1: </span><span class="si">%s</span><span class="s2"> with diff&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Diff: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">changed</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_import_module</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span>
                                    <span class="n">state</span><span class="o">=</span><span class="n">changed</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# M1&quot;</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;M2: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
        <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_import_module</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# M2&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># if a module file name starts with prefix, it should be a builtin</span>
        <span class="c1"># module, so should be pickled as a reference</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__file__&quot;</span><span class="p">):</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;base_prefix&quot;</span><span class="p">,</span> <span class="s2">&quot;base_exec_prefix&quot;</span><span class="p">,</span> <span class="s2">&quot;exec_prefix&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;prefix&quot;</span><span class="p">,</span> <span class="s2">&quot;real_prefix&quot;</span><span class="p">]</span>
            <span class="n">builtin_mod</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">obj</span><span class="o">.</span><span class="vm">__file__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
                           <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">name</span><span class="p">)])</span>
            <span class="n">builtin_mod</span> <span class="o">=</span> <span class="n">builtin_mod</span> <span class="ow">or</span> <span class="s1">&#39;site-packages&#39;</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__file__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">builtin_mod</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;builtins&quot;</span><span class="p">,</span> <span class="s2">&quot;dill&quot;</span><span class="p">)</span> \
           <span class="ow">and</span> <span class="ow">not</span> <span class="n">builtin_mod</span> <span class="ow">or</span> <span class="n">is_dill</span><span class="p">(</span><span class="n">pickler</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj</span> <span class="ow">is</span> <span class="n">pickler</span><span class="o">.</span><span class="n">_main</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;M1: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
            <span class="n">_main_dict</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1">#XXX: better no copy? option to copy?</span>
            <span class="p">[</span><span class="n">_main_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">singletontypes</span>
                <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;__builtins__&quot;</span><span class="p">,</span> <span class="s2">&quot;__loader__&quot;</span><span class="p">]]</span>
            <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_import_module</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span>
                                <span class="n">state</span><span class="o">=</span><span class="n">_main_dict</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# M1&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;M2: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
            <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_import_module</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# M2&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">return</span>

<span class="nd">@register</span><span class="p">(</span><span class="n">TypeType</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">save_type</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
   <span class="c1">#stack[id(obj)] = len(stack), obj #XXX: probably don&#39;t obj in all cases below</span>
    <span class="k">if</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">_typemap</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;T1: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
        <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_load_type</span><span class="p">,</span> <span class="p">(</span><span class="n">_typemap</span><span class="p">[</span><span class="n">obj</span><span class="p">],),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# T1&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;_fields&#39;</span><span class="p">,</span><span class="s1">&#39;_asdict&#39;</span><span class="p">,</span><span class="s1">&#39;_make&#39;</span><span class="p">,</span><span class="s1">&#39;_replace&#39;</span><span class="p">)]):</span>
        <span class="c1"># special case: namedtuples</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;T6: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
        <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_create_namedtuple</span><span class="p">,</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__qualname__&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span> <span class="n">obj</span><span class="o">.</span><span class="n">_fields</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__module__</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# T6&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">elif</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="nb">type</span><span class="p">):</span>
        <span class="c1">#   try: # used when pickling the class as code (or the interpreter)</span>
            <span class="k">if</span> <span class="n">is_dill</span><span class="p">(</span><span class="n">pickler</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pickler</span><span class="o">.</span><span class="n">_byref</span><span class="p">:</span>
                <span class="c1"># thanks to Tom Stepleton pointing out pickler._session unneeded</span>
                <span class="n">_t</span> <span class="o">=</span> <span class="s1">&#39;T2&#39;</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_t</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span>
                <span class="n">_dict</span> <span class="o">=</span> <span class="n">_dict_from_dictproxy</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="c1">#   except: # punt to StockPickler (pickle by class reference)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;T5: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
                <span class="n">StockPickler</span><span class="o">.</span><span class="n">save_global</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# T5&quot;</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_t</span> <span class="o">=</span> <span class="s1">&#39;T3&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_t</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span>
            <span class="n">_dict</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span>
       <span class="c1">#print (_dict)</span>
       <span class="c1">#print (&quot;%s\n%s&quot; % (type(obj), obj.__name__))</span>
       <span class="c1">#print (&quot;%s\n%s&quot; % (obj.__bases__, obj.__dict__))</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__slots__&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">del</span> <span class="n">_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_create_type</span><span class="p">,</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                           <span class="n">obj</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">,</span> <span class="n">_dict</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">_t</span><span class="p">)</span>
    <span class="c1"># special cases: NoneType</span>
    <span class="k">elif</span> <span class="n">obj</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;T7: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
            <span class="n">pickler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="s1">&#39;c__builtin__</span><span class="se">\n</span><span class="s1">NoneType</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;UTF-8&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pickler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;c__builtin__</span><span class="se">\n</span><span class="s1">NoneType</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# T7&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;T4: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
       <span class="c1">#print (obj.__dict__)</span>
       <span class="c1">#print (&quot;%s\n%s&quot; % (type(obj), obj.__name__))</span>
       <span class="c1">#print (&quot;%s\n%s&quot; % (obj.__bases__, obj.__dict__))</span>
        <span class="n">StockPickler</span><span class="o">.</span><span class="n">save_global</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# T4&quot;</span><span class="p">)</span>
    <span class="k">return</span>

<span class="nd">@register</span><span class="p">(</span><span class="nb">property</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">save_property</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Pr: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
    <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="nb">property</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">fget</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">fset</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">fdel</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">),</span>
                        <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# Pr&quot;</span><span class="p">)</span>

<span class="nd">@register</span><span class="p">(</span><span class="nb">staticmethod</span><span class="p">)</span>
<span class="nd">@register</span><span class="p">(</span><span class="nb">classmethod</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">save_classmethod</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cm: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
    <span class="n">im_func</span> <span class="o">=</span> <span class="s1">&#39;__func__&#39;</span> <span class="k">if</span> <span class="n">PY3</span> <span class="k">else</span> <span class="s1">&#39;im_func&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">orig_func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">im_func</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>  <span class="c1"># Python 2.6</span>
        <span class="n">orig_func</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="nb">object</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">classmethod</span><span class="p">):</span>
            <span class="n">orig_func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">orig_func</span><span class="p">,</span> <span class="n">im_func</span><span class="p">)</span> <span class="c1"># Unbind</span>
    <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="p">(</span><span class="n">orig_func</span><span class="p">,),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# Cm&quot;</span><span class="p">)</span>

<span class="nd">@register</span><span class="p">(</span><span class="n">FunctionType</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">save_function</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_locate_function</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span> <span class="c1">#, pickler._session):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;F1: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="s1">&#39;_recurse&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="c1"># recurse to get all globals referred to by obj</span>
            <span class="kn">from</span> <span class="nn">.detect</span> <span class="k">import</span> <span class="n">globalvars</span>
            <span class="n">globs</span> <span class="o">=</span> <span class="n">globalvars</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">builtin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># remove objects that have already been serialized</span>
           <span class="c1">#stacktypes = (ClassType, TypeType, FunctionType)</span>
           <span class="c1">#for key,value in list(globs.items()):</span>
           <span class="c1">#    if isinstance(value, stacktypes) and id(value) in stack:</span>
           <span class="c1">#        del globs[key]</span>
            <span class="c1"># ABORT: if self-references, use _recurse=False</span>
            <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">in</span> <span class="n">stack</span><span class="p">:</span> <span class="c1"># or obj in globs.values():</span>
                <span class="n">globs</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__globals__</span> <span class="k">if</span> <span class="n">PY3</span> <span class="k">else</span> <span class="n">obj</span><span class="o">.</span><span class="n">func_globals</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">globs</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__globals__</span> <span class="k">if</span> <span class="n">PY3</span> <span class="k">else</span> <span class="n">obj</span><span class="o">.</span><span class="n">func_globals</span>
        <span class="n">_byref</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="s1">&#39;_byref&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">_recurse</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="s1">&#39;_recurse&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">_memo</span> <span class="o">=</span> <span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">in</span> <span class="n">stack</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">_recurse</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
       <span class="c1">#print(&quot;stack: %s + &#39;%s&#39;&quot; % (set(hex(i) for i in stack),hex(id(obj))))</span>
        <span class="n">stack</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">),</span> <span class="n">obj</span>
        <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
            <span class="c1">#NOTE: workaround for &#39;super&#39; (see issue #75)</span>
            <span class="n">_super</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;super&#39;</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__code__</span><span class="p">,</span><span class="s1">&#39;co_names&#39;</span><span class="p">,()))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">_byref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_super</span><span class="p">:</span> <span class="n">pickler</span><span class="o">.</span><span class="n">_byref</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">_memo</span><span class="p">:</span> <span class="n">pickler</span><span class="o">.</span><span class="n">_recurse</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_create_function</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__code__</span><span class="p">,</span>
                                <span class="n">globs</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                <span class="n">obj</span><span class="o">.</span><span class="vm">__defaults__</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__closure__</span><span class="p">,</span>
                                <span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_super</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;super&#39;</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">func_code</span><span class="p">,</span><span class="s1">&#39;co_names&#39;</span><span class="p">,()))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">_byref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="s1">&#39;_recurse&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_super</span><span class="p">:</span> <span class="n">pickler</span><span class="o">.</span><span class="n">_byref</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">_memo</span><span class="p">:</span> <span class="n">pickler</span><span class="o">.</span><span class="n">_recurse</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">pickler</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_create_function</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">func_code</span><span class="p">,</span>
                                <span class="n">globs</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">func_name</span><span class="p">,</span>
                                <span class="n">obj</span><span class="o">.</span><span class="n">func_defaults</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">func_closure</span><span class="p">,</span>
                                <span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_super</span><span class="p">:</span> <span class="n">pickler</span><span class="o">.</span><span class="n">_byref</span> <span class="o">=</span> <span class="n">_byref</span>
        <span class="k">if</span> <span class="n">_memo</span><span class="p">:</span> <span class="n">pickler</span><span class="o">.</span><span class="n">_recurse</span> <span class="o">=</span> <span class="n">_recurse</span>
       <span class="c1">#clear = (_byref, _super, _recurse, _memo)</span>
       <span class="c1">#print(clear + (OLDER,))</span>
        <span class="c1">#NOTE: workaround for #234; &quot;partial&quot; still is problematic for recurse</span>
        <span class="k">if</span> <span class="n">OLDER</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_byref</span> <span class="ow">and</span> <span class="p">(</span><span class="n">_super</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">_super</span> <span class="ow">and</span> <span class="n">_memo</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">_super</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_memo</span> <span class="ow">and</span> <span class="n">_recurse</span><span class="p">)):</span> <span class="n">pickler</span><span class="o">.</span><span class="n">clear_memo</span><span class="p">()</span>
       <span class="c1">#if _memo:</span>
       <span class="c1">#    stack.remove(id(obj))</span>
       <span class="c1">#   #pickler.clear_memo()</span>
       <span class="c1">#   #StockPickler.clear_memo(pickler)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# F1&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;F2: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
        <span class="n">StockPickler</span><span class="o">.</span><span class="n">save_global</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span> <span class="c1">#NOTE: also takes name=...</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# F2&quot;</span><span class="p">)</span>
    <span class="k">return</span>

<span class="c1"># quick sanity checking</span>
<span class="k">def</span> <span class="nf">pickles</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">exact</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">safe</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;quick check if object pickles with dill&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">safe</span><span class="p">:</span> <span class="n">exceptions</span> <span class="o">=</span> <span class="p">(</span><span class="ne">Exception</span><span class="p">,)</span> <span class="c1"># RuntimeError, ValueError</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">exceptions</span> <span class="o">=</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AssertionError</span><span class="p">,</span> <span class="n">PicklingError</span><span class="p">,</span> <span class="n">UnpicklingError</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pik</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">pik</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">==</span> <span class="n">obj</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">pik</span> <span class="o">==</span> <span class="n">obj</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span> <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exact</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">pik</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>
            <span class="c1"># class instances might have been dumped with byref=False</span>
            <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">pik</span><span class="p">))</span> <span class="o">==</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span> <span class="c1">#XXX: InstanceType?</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="n">exceptions</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;check pickling of an object across another process&quot;&quot;&quot;</span>
   <span class="c1"># == undocumented ==</span>
   <span class="c1"># python -- the string path or executable name of the selected python</span>
   <span class="c1"># verbose -- if True, be verbose about printing warning messages</span>
   <span class="c1"># all other args and kwds are passed to dill.dumps</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">python</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">python</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">sys</span>
        <span class="n">python</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">executable</span>
    <span class="c1"># type check</span>
    <span class="nb">isinstance</span><span class="p">(</span><span class="n">python</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">subprocess</span>
    <span class="n">fail</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_obj</span> <span class="o">=</span> <span class="n">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
        <span class="n">fail</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fail</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DUMP FAILED&quot;</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> -c import dill; print(dill.loads(</span><span class="si">%s</span><span class="s2">))&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">python</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">_obj</span><span class="p">))</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;SUCCESS&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="k">else</span> <span class="s2">&quot;LOAD FAILED&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">return</span>

<span class="c1"># use to protect against missing attributes</span>
<span class="k">def</span> <span class="nf">is_dill</span><span class="p">(</span><span class="n">pickler</span><span class="p">,</span> <span class="n">child</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="s2">&quot;check the dill-ness of your pickler&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="n">PY34</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pickler</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="s1">&#39;mro&#39;</span><span class="p">)):</span>
        <span class="k">return</span> <span class="s1">&#39;dill&#39;</span> <span class="ow">in</span> <span class="n">pickler</span><span class="o">.</span><span class="vm">__module__</span>
    <span class="k">return</span> <span class="n">Pickler</span> <span class="ow">in</span> <span class="n">pickler</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">mro</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_extend</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;extend pickle with all of dill&#39;s registered types&quot;&quot;&quot;</span>
    <span class="c1"># need to have pickle not choke on _main_module?  use is_dill(pickler)</span>
    <span class="k">for</span> <span class="n">t</span><span class="p">,</span><span class="n">func</span> <span class="ow">in</span> <span class="n">Pickler</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">StockPickler</span><span class="o">.</span><span class="n">dispatch</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">except</span><span class="p">:</span> <span class="c1">#TypeError, PicklingError, UnpicklingError</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;skip: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">t</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">pass</span>
    <span class="k">return</span>

<span class="k">del</span> <span class="n">diff</span><span class="p">,</span> <span class="n">_use_diff</span><span class="p">,</span> <span class="n">use_diff</span>

<span class="c1"># EOF</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, pycalphad Development Team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>